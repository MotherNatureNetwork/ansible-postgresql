---

- name: install required SSL certs
  apt: name={{ item }}
  with_items:
    - apt-transport-https
    - ca-certificates

- name: Get PostgreSQL apt repo key.
  apt_key: url=https://www.postgresql.org/media/keys/ACCC4CF8.asc
           id=ACCC4CF8
           state=present

- name: Add PostgreSQL apt repo.
  apt_repository: repo='deb http://apt.postgresql.org/pub/repos/apt/ {{ postgresql_distro_version }}-pgdg main'
                  state=present

- name: Install PostgreSQL.
  apt: name={{ item }} update_cache=yes
  with_items:
    - postgresql-{{ postgresql_version }}
    - postgresql-server-dev-{{ postgresql_version }}
    - python-dev
    - python-psycopg2
  notify: reload postgresql

- name: Configure Postgres
  copy: src={{ item }}
        dest=/etc/postgresql/{{ postgresql_version }}/main/
        mode=0644
  with_items:
    - pg_hba.conf
  notify: reload postgresql

- name: force all notified handlers
  meta: flush_handlers

- name: Start and Enable Postgresql service
  systemd: name=postgresql state=started enabled=yes
  when: ansible_distribution_release == 'xenial'

- name: Create database
  postgresql_db: name={{ postgresql_database }}
                 state=present
                 login_unix_socket='/var/run/postgresql'
  register: postgres_db
  when: postgresql_database

- name: Create db user
  postgresql_user: name={{ postgresql_user }}
                   role_attr_flags={{ postgresql_user_attrs | join(",") }}
                   login_unix_socket='/var/run/postgresql'
  when: postgresql_user

- name: Restore DB
  command: pg_restore -d {{ postgresql_database }} {{ postgresql_dump }}
  when: postgres_db.changed == true and postgresql_dump is defined
  tags:
    - skip_ansible_lint
